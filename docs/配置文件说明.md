# 配置文件说明 (config.json)

## 概述
`config.json` 是系统的核心配置文件，包含了所有策略运行所需的参数设置。所有配置项都必须在此文件中定义，策略文件中不允许硬编码任何默认值。

## 架构设计原则
1. **单一配置源**: 所有配置参数必须在 `config.json` 中定义
2. **无默认值**: `config_manager.py` 中的 dataclass 不包含任何默认值，仅作为类型定义
3. **配置验证**: 系统启动时会验证所有必需的配置参数是否存在
4. **错误提示**: 如果配置文件不存在或参数缺失，系统会提供详细的错误信息和解决方案

## 配置结构

### 1. global 全局配置
全局配置项对所有策略生效，这些参数只能在 `global` 部分定义，不允许在策略文件中重复定义。

```json
"global": {
  "symbol": "BTCUSDT",                    // 交易对：比特币/USDT
  "start_date": "1 Oct, 2024",           // 回测开始日期
  "end_date": "8 Oct, 2024",             // 回测结束日期
  "initial_capital": 10000.0,            // 初始资金（美元）
  "leverage": 20.0,                      // 杠杆倍数：20倍杠杆
  "fee": 0.0004,                         // 交易手续费率：0.04%
  "maintenance_margin_rate": 0.02,       // 维持保证金率：2%
  "position_percentage": 0.95,           // 仓位使用比例：95%的资金用于交易
  "output_dir": "output"                 // 输出文件目录
}
```

#### 参数详解：
- **symbol**: 交易对符号，如 "BTCUSDT"、"ETHUSDT" 等
- **start_date**: 回测开始日期，格式："1 Oct, 2024"
- **end_date**: 回测结束日期，格式："8 Oct, 2024"
- **initial_capital**: 初始资金，单位为美元
- **leverage**: 杠杆倍数，影响仓位大小和风险
- **fee**: 交易手续费率，通常为 0.0004 (0.04%)
- **maintenance_margin_rate**: 维持保证金率，用于风险控制
- **position_percentage**: 资金使用比例，0.95 表示使用95%的资金进行交易
- **output_dir**: 输出文件存储目录

### 2. strategies 策略配置
每个策略的特定参数配置。

#### 2.1 simple_ema (简单EMA交叉策略)
```json
"simple_ema": {
  "strategy_name": "简单EMA交叉策略",
  "strategy_type": "simple_ema",
  "ema_short": 9,                        // 短期EMA周期
  "ema_long": 26                         // 长期EMA周期
}
```

#### 2.2 staged_ema (分批入场EMA交叉策略)
```json
"staged_ema": {
  "strategy_name": "分批入场EMA交叉策略",
  "strategy_type": "staged_ema",
  "ema_short": 9,                        // 短期EMA周期
  "ema_long": 26,                        // 长期EMA周期
  "interval_30min": "30m",               // 30分钟时间框架
  "interval_1min": "1m",                 // 1分钟时间框架
  "initial_entry_percentage": 0.37,      // 初始入场比例
  "staged_entry_percentages": [          // 分批入场比例数组
    0.01, 0.02, 0.04, 0.08, 0.16, 0.32
  ]
}
```

### 3. strategies_to_run 运行策略列表
指定要运行的策略列表：
```json
"strategies_to_run": [
  "simple_ema", 
  "staged_ema"
]
```

### 4. backtest 回测配置
```json
"backtest": {
  "enable_monthly_split": true,          // 是否启用月度分割
  "monthly_split_config": {
    "save_monthly_files": true,          // 是否保存月度文件
    "monthly_output_dir": "output/monthly_data"  // 月度数据输出目录
  }
}
```

### 5. logging 日志配置
```json
"logging": {
  "enable_detailed_log": true,           // 是否启用详细日志
  "log_trades_to_file": true,            // 是否将交易记录到文件
  "log_file_prefix": "trades_detailed_log",  // 日志文件前缀
  "log_level": "INFO",                   // 日志级别
  "save_txt_log": true,                  // 是否保存txt格式的详细日志
  "txt_log_format": "detailed",          // txt日志格式：detailed(详细)/simple(简单)
  "txt_log_include_summary": true,       // 是否在txt日志中包含交易总结
  "txt_log_real_time": true              // 是否实时写入txt日志
}
```

**txt日志功能说明：**
- `save_txt_log`: 控制是否生成txt格式的详细交易日志文件
- `txt_log_format`: 设置txt日志的详细程度，"detailed"包含完整信息
- `txt_log_include_summary`: 是否在文件末尾包含按trade_id分组的交易总结
- `txt_log_real_time`: 是否在策略运行时实时写入日志（推荐开启）

**txt日志文件内容包括：**
- 策略基本信息（回测时间、交易标的、初始资金等）
- 实时交易日志（每次入场、加仓、平仓的详细信息）
- 交易总结（按trade_id分组的完整交易记录，包含盈亏分析）

### 6. chart 图表配置
```json
"chart": {
  "use_arrows_for_trades": true,         // 是否使用箭头标记交易
  "avoid_text_overlap": true,            // 是否避免文本重叠
  "chart_dpi": 300,                      // 图表DPI
  "save_chart": true,                    // 是否保存图表
  "chart_width": 15,                     // 图表宽度
  "chart_height": 10,                    // 图表高度
  "show_volume": false                   // 是否显示成交量
}
```

### 7. output 输出配置
```json
"output": {
  "directory": "output"                  // 输出目录
}
```

## 重要规则

### 1. 配置优先级
- **global配置**: 对所有策略生效的基础配置
- **策略配置**: 每个策略的特定参数
- **不允许覆盖**: 策略文件中不能重新定义global中的参数

### 2. 配置管理原则
- ✅ **所有配置必须在config.json中定义**
- ❌ **策略文件中不允许硬编码默认值**
- ❌ **策略文件中不允许重复定义global参数**
- ✅ **使用config_manager.py统一管理配置读取**

### 3. 修改配置
1. 修改配置时，只需要编辑 `config.json` 文件
2. 重启程序后新配置生效
3. 确保JSON格式正确（不支持注释）

## 配置模板

为了方便理解和配置，我们提供了一个带有详细注释的配置模板文件：`config_template_with_comments.jsonc`

该模板文件包含：
- 详细的中文注释说明每个配置项的作用
- 所有可用的配置选项
- 推荐的默认值
- 配置项的分类和组织

**使用方法：**
1. 复制 `config_template_with_comments.jsonc` 的内容
2. 移除所有注释（以 `//` 开头的行）
3. 根据需要修改配置值
4. 保存为 `config.json`

**注意：** 标准的 JSON 格式不支持注释，因此实际的 `config.json` 文件中不能包含 `//` 注释。

## 示例用法

### 修改交易对
```json
"global": {
  "symbol": "ETHUSDT"  // 改为以太坊交易对
}
```

### 调整回测时间范围
```json
"global": {
  "start_date": "1 Nov, 2024",
  "end_date": "30 Nov, 2024"
}
```

### 修改EMA参数
```json
"simple_ema": {
  "ema_short": 12,     // 改为12周期
  "ema_long": 30       // 改为30周期
}
```

## config_manager.py 架构说明

### 配置管理器的作用
`config_manager.py` 文件负责：
1. **配置加载**: 从 `config.json` 文件加载所有配置参数
2. **类型定义**: 通过 dataclass 定义配置参数的类型和结构
3. **配置合并**: 将全局配置与策略特定配置合并
4. **配置验证**: 确保所有必需的参数都已定义
5. **实例创建**: 为策略创建类型安全的配置实例

### 重要变化
- **移除默认值**: 所有 dataclass 不再包含默认值，仅作为类型定义使用
- **强制配置**: 如果 `config.json` 不存在或缺少参数，系统会抛出错误并提供详细说明
- **配置重置功能禁用**: `reset_to_default()` 方法已禁用，所有配置修改必须通过编辑 `config.json` 完成

### 错误处理
如果遇到配置相关错误，系统会提示：
1. 检查 `config.json` 文件是否存在
2. 参考 `config_template_with_comments.jsonc` 模板
3. 查看本文档了解配置结构
4. 确保所有必需参数都已定义

## 注意事项

1. **不允许硬编码默认值**：所有策略参数必须在 `config.json` 中明确定义，策略文件中不允许设置默认值
2. **global配置的唯一性**：`global` 配置项只能在 `config.json` 的 `global` 部分定义，不允许在策略配置中重复定义
3. **配置验证**：系统会在启动时验证配置的完整性和正确性
4. **类型安全**：确保配置值的类型与预期一致（如数字、字符串、布尔值等）
5. **JSON格式要求**：`config.json` 必须是有效的JSON格式，不支持注释