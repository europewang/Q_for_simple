# 交易记录功能说明

## 📋 功能概述

系统现在会自动将所有交易操作记录到 `trade_records.txt` 文件中，包括开仓、平仓的详细信息，方便您跟踪和分析交易历史。

**🆕 新增功能：动态交易金额调整 (只增不减，含保险金机制)**
- **修复**：解决了 `WebTrader` 初始化时 `max_capital_multiplier_file` 属性未及时初始化导致的 `AttributeError`。现在，`max_capital_multiplier_file`、`max_capital_multiplier`、`insurance_fund` 和 `last_insurance_fund_multiplier_threshold` 等属性的初始化和加载逻辑已提前到系统核心组件初始化之前，确保在任何依赖这些属性的方法被调用时，它们都已准备就绪。
- 系统现在会维护一个 `capital_multiplier.json` 文件（位于 `web_trader.py` 同级目录），用于持久化存储历史最大交易倍数、**保险金 (`insurance_fund`) 和上次保险金倍数阈值 (`last_insurance_multiplier_threshold`)**。
- 每次开仓前，系统会获取当前账户的U本位总金额。
- **保险金累积机制**：当当前资金与初始资金的比例 (`capital_ratio`) 超过 `n.5` 倍（例如 1.5, 2.5, 3.5 等）时，系统会从当前资金中提取 1/10 作为保险金累积起来。每个 `n.5` 阈值只会触发一次保险金累积，并通过 `last_insurance_fund_multiplier_threshold` 进行记录，防止重复累积。
- 根据**扣除保险金后的当前总金额**与初始资金（`initial_capital`）的倍数关系，动态计算出本次交易的 `fixed_trade_amount`。
- **关键改进**：`capital_multiplier` 现在只增不减。系统会比较当前计算出的倍数（**基于扣除保险金后的资金**）与 `capital_multiplier.json` 中记录的历史最大倍数，始终使用两者中的较大值作为当前的交易倍数。
- 调整后的 `fixed_trade_amount` 将作为 `WebTrader` 实例的 `self.current_fixed_trade_amount` 属性，用于本次交易的计算。
- 这有助于在资金增长时，按比例增加每次交易的投入，实现资金的有效利用，同时通过保险金机制，在资金快速增长时预留一部分资金作为安全垫，防止倍数增长过快，并避免直接修改全局配置。

**🆕 新增功能：动态杠杆调整**
- 系统现在支持根据交易盈亏自动调整杠杆倍数
- 亏损后杠杆增加2倍，盈利后杠杆回归基础值25倍
- 所有杠杆变化都会在日志中详细记录

**🔧 重要修复：EMA交叉检测逻辑优化（2024-12-28）**
- **问题描述**：原有的EMA交叉检测依赖历史K线数据比较，存在以下问题：
  - 当K线数据更新延迟时，可能错过真实的EMA交叉信号
  - 如果某个半小时检测点被遗漏，可能导致持仓方向与EMA信号不匹配
  - 基于前后两根K线的比较方式不够稳定

- **修复方案**：重新设计EMA交叉检测逻辑
  - **新逻辑**：基于当前EMA信号状态与持仓方向的匹配度进行判断
  - **检测原理**：
    - 获取当前EMA9和EMA26的实时值
    - 判断当前EMA信号状态（多头：EMA9 > EMA26，空头：EMA9 < EMA26）
    - 获取当前持仓方向（多头/空头/无持仓）
    - 如果EMA信号与持仓方向不匹配，则触发交易信号

- **优势**：
  - ✅ 避免因半小时检测遗漏而错过交易机会
  - ✅ 确保持仓方向始终与当前EMA信号保持一致
  - ✅ 基于当前状态判断，不依赖历史数据变化
  - ✅ 提高交易信号的准确性和及时性

- **交易逻辑**：
  - 当前EMA多头信号 + 无持仓/空头持仓 → 执行做多操作
  - 当前EMA空头信号 + 无持仓/多头持仓 → 执行做空操作
  - EMA信号与持仓方向一致 → 无需交易

**🛡️ 半小时检测保障机制
- **检测状态持久化**：将检测时间记录保存到 `logs/detection_state.json` 文件
- **启动时检测恢复**：程序启动时自动检查并补偿遗漏的检测点
- **修复启动时遗漏检查错误**：解决了 `hour must be in 0..23, not 24` 的时间处理错误，确保跨午夜的检测点也能正确处理。
- **实时状态保存**：每次检测完成后立即更新状态文件
- **检测窗口机制**：每个检测点有30秒窗口，防重复检测
- **补偿检测**：基于当前EMA状态和持仓情况自动执行遗漏的检测
- **异常恢复**：即使程序异常重启也能保持检测的连续性

## 📄 文件位置

```
simple_live_trading/trade_records.txt
```

## 📊 记录格式

每条交易记录包含以下信息：

```
[时间] 操作类型 | 交易对 | 方向 | 价格 | 数量 | 盈亏 | 备注
```

### 字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| 时间 | 交易执行的具体时间 | `2025-10-12 20:29:30` |
| 操作类型 | 开仓或平仓 | `开仓` / `平仓` |
| 交易对 | 交易的币种对 | `BTCUSDT` / `ETHUSDT` |
| 方向 | 多头或空头 | `多头` / `空头` |
| 价格 | 交易执行价格 | `67,500.00` |
| 数量 | 交易数量 | `0.0100` |
| 盈亏 | 平仓时的盈亏金额 | `+7.00 USDT` / `-3.50 USDT` |
| 备注 | 交易触发原因 | `EMA交叉信号` |

## 📈 记录示例

### 开仓记录
```
[2025-10-12 20:29:30] 开仓 | BTCUSDT | 多头 | 67,500.00 | 0.0100 | - | EMA交叉信号
```

### 平仓记录
```
[2025-10-12 20:29:30] 平仓 | BTCUSDT | 多头 | 68,200.00 | 0.0100 | +7.00 USDT | EMA交叉信号
```

## 🔄 自动记录机制

系统会在以下情况自动写入交易记录：

1. **开仓时**：记录开仓价格、数量、方向
2. **平仓时**：记录平仓价格、数量、盈亏金额

## 💰 盈亏计算

- **多头盈亏** = (平仓价格 - 开仓价格) × 数量 × 杠杆倍数
- **空头盈亏** = (开仓价格 - 平仓价格) × 数量 × 杠杆倍数

## 📊 数据分析建议

您可以使用这个文件进行：

1. **交易统计**：计算总交易次数、胜率、平均盈亏
2. **策略分析**：分析不同时间段的交易表现
3. **风险管理**：监控最大回撤和连续亏损
4. **Excel分析**：将数据导入Excel进行图表分析

## 🛠️ 文件管理

- 文件会自动创建，无需手动操作
- 记录会持续追加，不会覆盖历史数据
- 建议定期备份重要的交易记录
- 可以手动清空文件重新开始记录

## ⚠️ 注意事项

1. 文件使用UTF-8编码，支持中文显示
2. 时间格式为24小时制
3. 价格显示包含千位分隔符
4. 盈亏金额显示正负号和货币单位
5. 模拟交易和真实交易都会被记录

## 🎯 动态杠杆功能详解

### 📊 杠杆调整规则

系统采用智能杠杆调整策略，根据交易结果自动优化风险管理：

| 交易结果 | 杠杆调整规则 | 示例 |
|----------|-------------|------|
| 盈利交易 | 杠杆重置为基础值25x | 30x → 25x |
| 亏损交易 | 杠杆增加2倍 | 25x → 27x |

### 🔄 调整机制

1. **初始状态**：系统启动时杠杆为25x（基础杠杆）
2. **亏损处理**：每次亏损后，下一单杠杆增加2倍
3. **盈利重置**：一旦盈利，杠杆立即回归25x基础值
4. **连续调整**：支持连续亏损时杠杆持续增加

### 📈 调整示例

```
交易序列：亏损 → 亏损 → 盈利 → 亏损
杠杆变化：25x → 27x → 29x → 25x → 27x
```

### 🛡️ 风险控制

- **基础杠杆**：25倍，平衡收益与风险
- **增量控制**：每次仅增加2倍，避免过度风险
- **及时重置**：盈利后立即重置，防止杠杆过高

### 📝 日志记录

系统会详细记录所有杠杆调整：

```
2025-10-18 22:01:47 - INFO - 📉 ETHUSDT 本次交易亏损 -3.00 USDT，杠杆增加到 27x
2025-10-18 22:01:47 - INFO - 🔄 ETHUSDT 杠杆调整: 25x → 27x
2025-10-18 22:01:47 - INFO - ✅ ETHUSDT 币安杠杆已更新为 27x
```

## 🔧 自定义设置

如需修改记录格式或添加更多字段，可以编辑 `web_trader.py` 文件中的 `write_trade_record` 方法。

### 动态杠杆参数调整

可在 `CONFIG` 配置中修改以下参数：

```python
CONFIG = {
    "base_leverage": 25,        # 基础杠杆倍数
    "leverage_increment": 2,    # 亏损后杠杆增加量
}
```

## 🚀 服务器自动启动配置

系统已配置为systemd服务，支持服务器重启后自动启动。

### 📋 服务配置

- **服务名称**：`web-trader.service`
- **服务描述**：Web Trader - Dynamic Leverage Trading System
- **自动启动**：已启用开机自启
- **重启策略**：服务异常退出时自动重启（间隔10秒）

### 🛠️ 服务管理命令

#### 使用systemctl命令
```bash
# 查看服务状态
sudo systemctl status web-trader.service

# 启动服务
sudo systemctl start web-trader.service

# 停止服务
sudo systemctl stop web-trader.service

# 重启服务
sudo systemctl restart web-trader.service

# 启用开机自启
sudo systemctl enable web-trader.service

# 禁用开机自启
sudo systemctl disable web-trader.service

# 查看服务日志
sudo journalctl -u web-trader.service -f
```

### 📁 日志文件位置

- **标准输出日志**：`/home/ubuntu/Code/quant/simple_live_trading/logs/web_trader_service.log`
- **错误日志**：`/home/ubuntu/Code/quant/simple_live_trading/logs/web_trader_service_error.log`
- **系统日志**：通过 `journalctl -u web-trader.service` 查看

### 🔧 服务配置文件

服务配置文件位于：`/etc/systemd/system/web-trader.service`

主要配置：
```ini
[Unit]
Description=Web Trader Service
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/Code/quant/simple_live_trading
ExecStart=/home/ubuntu/miniconda3/bin/conda run -n quant python web_trader.py
Restart=always
RestartSec=3
StandardOutput=append:/home/ubuntu/Code/quant/simple_live_trading/logs/web_trader_service.log
StandardError=append:/home/ubuntu/Code/quant/simple_live_trading/logs/web_trader_service_error.log

[Install]
WantedBy=multi-user.target
```

### ⚠️ 注意事项

1. **环境依赖**：服务依赖conda环境`quant`，确保环境正常
2. **端口占用**：服务使用5001端口，确保端口未被占用
3. **权限要求**：服务管理需要sudo权限
4. **日志监控**：建议定期检查日志文件，监控服务运行状态
5. **配置更新**：修改配置后需要重新加载服务：
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl restart web-trader.service
   ```

### 🎯 开机自启验证

重启服务器后，可通过以下方式验证自动启动：

```bash
# 检查服务状态
sudo systemctl status web-trader.service

# 检查端口监听
lsof -i:5001

# 检查进程
ps aux | grep web_trader.py
```

服务正常启动后，可通过浏览器访问：`http://服务器IP:5001`

## 🔧 其他启动方式

### 📱 nohup后台启动

如果不想使用systemd服务，也可以使用nohup命令后台启动：

#### 基本nohup启动

```bash
# 进入项目目录
cd /home/ubuntu/Code/quant/simple_live_trading

# 激活conda环境并后台启动
conda activate quant
nohup python web_trader.py > web_trader_nohup.log 2>&1 &

# 查看进程
ps aux | grep web_trader.py

# 查看日志
tail -f web_trader_nohup.log
```

#### 使用启动脚本的nohup方式

```bash
# 或者直接指定conda环境
nohup /home/ubuntu/miniconda3/envs/quant/bin/python web_trader.py > web_trader_nohup.log 2>&1 &
```

#### nohup进程管理

```bash
# 查找进程ID
ps aux | grep web_trader.py | grep -v grep

# 停止进程（替换PID为实际进程ID）
kill -9 <PID>

# 或者使用pkill
pkill -f web_trader.py

# 检查端口占用
lsof -i:5001
```

### ⚙️ 修改自动启动配置

#### 修改systemd服务配置

如果需要修改服务的启动参数、环境变量或其他配置：

```bash
# 1. 编辑服务配置文件
sudo nano /etc/systemd/system/web-trader.service

# 2. 重新加载配置
sudo systemctl daemon-reload

# 3. 重启服务
sudo systemctl restart web-trader.service
```

#### 常见配置修改示例

**修改工作目录：**
```ini
[Service]
WorkingDirectory=/新的/工作/目录
```

**修改Python环境：**
```ini
[Service]
ExecStart=/path/to/your/python /path/to/web_trader.py
```

**添加环境变量：**
```ini
[Service]
Environment="API_KEY=your_api_key"
Environment="SECRET_KEY=your_secret_key"
```

**修改重启策略：**
```ini
[Service]
Restart=on-failure          # 仅失败时重启
# 或
Restart=no                   # 不自动重启
```

**修改用户和组：**
```ini
[Service]
User=your_username
Group=your_group
```

#### 禁用自动启动

如果不需要开机自启：

```bash
# 禁用开机自启
sudo systemctl disable web-trader.service

# 停止服务
sudo systemctl stop web-trader.service

# 查看状态
sudo systemctl status web-trader.service
```

#### 完全移除systemd服务

```bash
# 1. 停止并禁用服务
sudo systemctl stop web-trader.service

# 2. 删除服务文件
sudo rm /etc/systemd/system/web-trader.service

# 3. 重新加载systemd
sudo systemctl daemon-reload

# 4. 重置失败状态（如果有）
sudo systemctl reset-failed
```

### 🔄 启动方式对比

| 启动方式 | 优点 | 缺点 | 适用场景 |
|---------|------|------|----------|
| **systemd服务** | 开机自启、自动重启、日志管理、系统集成 | 需要root权限配置 | 生产环境、长期运行 |
| **nohup后台** | 简单快速、无需root权限 | 不会开机自启、需手动管理 | 临时测试、开发环境 |
| **直接运行** | 最简单、便于调试 | 终端关闭即停止 | 开发调试 |

### 📝 配置文件备份

建议备份重要配置文件：

```bash
# 备份systemd服务文件
sudo cp /etc/systemd/system/web-trader.service /home/ubuntu/Code/quant/simple_live_trading/web-trader.service.backup

# 备份启动脚本
cp /home/ubuntu/Code/quant/simple_live_trading/start_web_trader.sh /home/ubuntu/Code/quant/simple_live_trading/start_web_trader.sh.backup

# 备份管理脚本
cp /home/ubuntu/Code/quant/simple_live_trading/manage_service.sh /home/ubuntu/Code/quant/simple_live_trading/manage_service.sh.backup
```