# EMA交叉点分析工具

## 功能描述

这个工具从币安API获取ETHUSDT的30分钟K线数据，计算EMA9和EMA26的交叉点，并生成可视化图表。支持半年期分析，自动识别突兀点并生成详细报告。

## 主要功能

1. **数据获取**: 从币安API获取ETHUSDT的30分钟K线数据
2. **EMA计算**: 计算9周期和26周期的指数移动平均线
3. **交叉点检测**: 识别金叉和死叉信号
4. **突兀点识别**: 使用均值×2的方法识别价格差值异常的交叉点
5. **数据可视化**: 为每个半年期生成两个图表
   - 序号 vs 价格差值图表
   - 时间 vs 价格差值图表
6. **数据导出**: 将结果保存为多个CSV文件
7. **时区转换**: 所有时间显示为中国时区（UTC+8）
8. **前一交叉时间**: 记录每个突兀点的前一个交叉点时间

## 分析时间范围

- **开始时间**: 2023年1月1日
- **结束时间**: 2025年10月15日
- **分析周期**: 按半年期分段分析
- **数据周期**: 30分钟K线

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

```bash
conda activate quant
cd backtest_for_rule
python ema_backtest_periods.py
```

## 输出文件

运行完成后会在 `period_analysis` 目录下生成以下文件：

### 图表文件
- **ema_analysis_*.png**: 每个半年期的图表文件，包含两个子图
  - 上图: 交叉点序号 vs 与前一交叉点价格差值绝对值
  - 下图: 时间（从统计开始的天数）vs 与前一交叉点价格差值绝对值

### 数据文件
1. **ema_results_*.csv**: 突兀点交叉记录文件，包含：
   - sequence: 交叉点序号
   - open_time_china: 交叉点时间（中国时区）
   - close: 交叉点处的价格
   - ema9: EMA9值
   - ema26: EMA26值
   - crossover_type: 交叉类型（金叉/死叉）
   - price_diff_abs: 与前一交叉点价格差值绝对值
   - prev_crossover_time: 前一个交叉点的时间

2. **outliers_*.csv**: 突兀点详细数据，包含：
   - sequence: 交叉点序号
   - open_time_china: 交叉点时间（中国时区）
   - close: 交叉点处的价格
   - ema9: EMA9值
   - ema26: EMA26值
   - crossover_type: 交叉类型（金叉/死叉）
   - price_diff_abs: 与前一交叉点价格差值绝对值
   - sequence_interval: 与前一突兀点的序号间隔
   - time_interval_days: 与前一突兀点的时间间隔（天）
   - time_interval_hours: 与前一突兀点的时间间隔（小时）

3. **backtest_summary_report.md**: 总结报告文件

## 分析结果示例

```
============================================================
EMA交叉点分析摘要 - 2025年上半年
============================================================
分析时间范围: 2025-01-01 到 2025-06-30
交易对: ETHUSDT
K线周期: 30m
总交叉点数量: 254
金叉数量: 127
死叉数量: 127
突兀点数量: 21
突兀金叉数量: 11
突兀死叉数量: 10
价格范围: $1448.95 - $4795.00
平均价格: $2896.32
============================================================
```

## 技术说明

### EMA计算公式
- EMA = (当前价格 × 平滑系数) + (前一日EMA × (1 - 平滑系数))
- 平滑系数 = 2 / (周期数 + 1)

### 交叉点识别
- **金叉**: EMA9从下方穿越EMA26向上
- **死叉**: EMA9从上方穿越EMA26向下

### 突兀点识别
- 计算所有交叉点的价格差值绝对值的平均值
- 突兀点定义：价格差值绝对值 > 平均值 × 2
- 只有突兀点会被保存到交叉记录文件中

### 图表说明

生成的图表包含两个子图，采用折线图形式展示价格差值变化趋势：

1. **上图：交叉点序号 vs 价格差值绝对值**
   - X轴：交叉点的序号（按时间顺序）
   - Y轴：当前交叉点与前一交叉点的价格差值绝对值
   - 蓝色折线：连接所有交叉点的价格差值变化趋势
   - 红色小点：金叉（EMA9上穿EMA26）
   - 绿色小点：死叉（EMA9下穿EMA26）
   - 橙色虚线：趋势线

2. **下图：时间 vs 价格差值绝对值**
   - X轴：从统计开始时间的天数
   - Y轴：当前交叉点与前一交叉点的价格差值绝对值
   - 蓝色折线：连接所有交叉点的价格差值变化趋势
   - 红色小点：金叉
   - 绿色小点：死叉
   - 橙色虚线：趋势线

- 第一个交叉点的差值设为0（因为没有前一个交叉点）

## 注意事项

1. 需要稳定的网络连接来访问币安API
2. 脚本会自动处理API请求限制，添加了适当的延迟
3. 如果网络不稳定，可能需要重新运行脚本
4. 生成的图表会自动保存，无需手动操作

## 自定义配置

如需修改分析参数，可以编辑 `ema_backtest_periods.py` 文件中的以下变量：

```python
self.symbol = "ETHUSDT"        # 交易对
self.interval = "30m"          # K线周期
self.start_date = "2023-01-01" # 开始日期
self.end_date = "2025-10-15"   # 结束日期
```

EMA周期可以在 `find_crossover_points` 方法中修改：

```python
df['ema9'] = self.calculate_ema(df['close'], 9)   # EMA9周期
df['ema26'] = self.calculate_ema(df['close'], 26) # EMA26周期
```

突兀点识别阈值可以在 `create_period_chart` 方法中修改：

```python
# 当前使用平均值的2倍作为阈值
outlier_threshold = avg_price_diff * 2
```

---

# 突兀点交易策略回测系统

基于EMA交叉点的突兀点识别和等待机制的交易策略。

## 策略逻辑

### 核心概念
- **突兀点**：当EMA交叉点的价格差值绝对值大于ah值时，标记为突兀点
- **ah值**：突兀点差值标准，基于历史交叉点价格差值计算
- **adx值**：突兀点出现频率，决定等待的普通交叉点数量

### 交易规则

#### 入场触发
- **条件**：距离上一个突兀点过了adx个普通交叉点
- **执行**：根据当前交叉点类型决定交易方向
  - 金叉（EMA9>EMA26）→ 做多
  - 死叉（EMA9<EMA26）→ 做空

#### 出场触发
- **触发1**：发现新的突兀点（价格差值绝对值>ah值）
  - 立即平仓
  - 重新进入等待状态，等待adx个普通交叉点
  
- **触发2**：出现普通交叉点（非突兀点）
  - 立即平仓
  - 立即根据新交叉点类型再开仓
  - 如此循环往复，直到遇到新突兀点（触发1）

### 参数计算
- **计算频率**：每15天重新计算ah和adx值
- **回顾期**：基于过去180天的历史数据
- **ah计算**：历史交叉点价格差值绝对值的平均值 × 2.5
- **adx计算**：突兀点间隔的平均值 ÷ 4（最小为1）

## 文件说明

- `outlier_trading_strategy.py` - 主策略文件
- `ema_crossover_analysis.py` - EMA交叉点分析工具
- `analyze_price_diff.py` - 价格差值分析工具
- `ema_backtest_periods.py` - EMA周期回测工具

## 运行方式

```bash
# 激活conda环境
conda activate quant

# 运行策略
python outlier_trading_strategy.py
```

## 输出文件

- `outlier_strategy_results/` - 策略回测结果目录
  - `backtest_report.txt` - 详细回测报告（包含完整交易记录表）
  - `trades_record.csv` - 交易记录
  - `completed_trades.csv` - 完整交易记录
  - `crossover_history.csv` - 交叉点历史
  - `ah_history.csv` - ah值历史
  - `adx_history.csv` - adx值历史

## 最新更新

### 2025-01-17 策略逻辑修正
- 修正了入场逻辑：确保在距离上一个突兀点过了adx个普通交叉点后才入场
- 修正了出场触发机制：
  - 触发1：遇到新突兀点时立即平仓并重新等待
  - 触发2：遇到普通交叉点时立即平仓再开仓，循环往复
- 优化了交易执行逻辑，支持独立的平仓和开仓操作
- 增强了回测报告，包含详细的交易记录表格